<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlumbPro Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter Font -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .status-scheduled { @apply bg-blue-100 text-blue-800; }
        .status-onsite { @apply bg-yellow-100 text-yellow-800; }
        .status-completed { @apply bg-green-100 text-green-800; }
        .is-recording {
            @apply ring-4 ring-red-300 shadow-xl;
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen">
        <!-- Header -->
        <header class="bg-blue-600 shadow-lg p-4 text-white">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold">ðŸ’§ PlumbPro Dashboard</h1>
                <div class="text-sm">
                    <span class="opacity-80">User:</span>
                    <span id="user-id" class="font-mono text-xs bg-blue-700 px-2 py-1 rounded-full ml-1">Loading...</span>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="max-w-7xl mx-auto p-4 md:p-8">

            <!-- New Job Card / Form -->
            <div class="bg-white shadow-xl rounded-xl p-6 mb-8 border border-blue-200">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Schedule New Job
                </h2>
                <form id="add-job-form" class="space-y-4">
                    <div>
                        <label for="customerName" class="block text-sm font-medium text-gray-700">Customer Name</label>
                        <input type="text" id="customerName" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                    </div>
                    <div>
                        <label for="address" class="block text-sm font-medium text-gray-700">Address</label>
                        <input type="text" id="address" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="scheduledTime" class="block text-sm font-medium text-gray-700">Scheduled Date/Time</label>
                            <input type="datetime-local" id="scheduledTime" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700">Description (e.g., Leaky faucet)</label>
                            <input type="text" id="description" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                    </div>
                    <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">
                        Add Job
                    </button>
                    <div id="form-message" class="text-sm text-center text-red-500 hidden"></div>
                </form>
            </div>

            <!-- Job List / Calendar View -->
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                Today's Job Queue
            </h2>
            <div id="mic-api-warning" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 hidden" role="alert">
                <strong class="font-bold">Warning!</strong>
                <span class="block sm:inline">Voice-to-Text requires a modern browser like Chrome or Edge and may not be supported.</span>
            </div>

            <div id="jobs-container" class="space-y-4">
                <div class="text-center p-10 bg-white rounded-xl shadow-md" id="loading-indicator">
                    <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full"></div>
                    <p class="mt-2 text-gray-500">Loading jobs...</p>
                </div>
            </div>

        </main>
    </div>

    <!-- Modals for Summary Output -->
    <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden transition-opacity z-40"></div>
    <div id="summary-modal" class="fixed inset-0 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="p-5 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    Invoice Summary
                </h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="p-5">
                <div id="summary-output" class="text-gray-700 whitespace-pre-wrap"></div>
                <div id="summary-loading" class="text-center py-8">
                    <div class="animate-spin inline-block w-6 h-6 border-4 border-blue-500 border-t-transparent rounded-full"></div>
                    <p class="mt-2 text-blue-500">Generating professional summary...</p>
                </div>
                <button onclick="copySummary()" id="copy-summary-btn" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 rounded-lg transition duration-150 hidden">
                    Copy to Clipboard
                </button>
                <p id="copy-message" class="text-sm text-green-600 mt-2 hidden text-center"></p>
            </div>
        </div>
    </div>


    <!-- JavaScript and Firebase Setup -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES (Provided by Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-plumbpro-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`; // Key will be provided by environment

        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false;

        // --- Voice-to-Text Variables ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let currentRecordingJobId = null;

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                document.getElementById('loading-indicator').innerHTML = '<p class="text-red-500">Error: Firebase configuration is missing.</p>';
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Initialize Speech Recognition if supported
                if (SpeechRecognition) {
                    recognition = new SpeechRecognition();
                    recognition.continuous = true;
                    recognition.interimResults = true;
                    setupVoiceRecognitionListeners();
                } else {
                    document.getElementById('mic-api-warning').classList.remove('hidden');
                }

                // Set up Authentication
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for Auth State Changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        isAuthReady = true;
                        document.getElementById('user-id').textContent = currentUserId;
                        setupJobListener();
                        setupFormListener();
                    } else {
                        console.error("User signed out unexpectedly.");
                        document.getElementById('user-id').textContent = 'Signed Out';
                    }
                });

            } catch (error) {
                console.error("Error initializing or authenticating Firebase:", error);
                document.getElementById('loading-indicator').innerHTML = `<p class="text-red-500">Auth Error: ${error.message}</p>`;
            }
        }
        
        // --- FIREBASE UTILITIES ---

        function getJobsCollectionRef() {
            if (!db || !currentUserId) {
                console.error("Database or User ID not available.");
                return null;
            }
            // Use private data path: /artifacts/{appId}/users/{userId}/jobs
            return collection(db, `artifacts/${appId}/users/${currentUserId}/jobs`);
        }

        function setupJobListener() {
            const jobsRef = getJobsCollectionRef();
            if (!jobsRef) return;

            const q = query(jobsRef);

            onSnapshot(q, (snapshot) => {
                const jobs = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    jobs.push({
                        id: doc.id,
                        ...data,
                        scheduledTime: data.scheduledTime ? data.scheduledTime.toDate() : new Date(),
                    });
                });
                jobs.sort((a, b) => a.scheduledTime - b.scheduledTime);
                renderJobs(jobs);
            }, (error) => {
                console.error("Error listening to jobs:", error);
                document.getElementById('jobs-container').innerHTML = '<p class="text-red-500">Failed to load jobs in real-time.</p>';
            });
        }

        async function addNewJob(jobData) {
            const jobsRef = getJobsCollectionRef();
            const messageEl = document.getElementById('form-message');
            messageEl.classList.add('hidden');

            if (!jobsRef) {
                messageEl.textContent = 'System error: Cannot connect to database.';
                messageEl.classList.remove('hidden');
                return;
            }

            try {
                const scheduledDate = new Date(jobData.scheduledTime);
                
                await addDoc(jobsRef, {
                    customerName: jobData.customerName,
                    address: jobData.address,
                    scheduledTime: scheduledDate,
                    description: jobData.description,
                    status: 'Scheduled',
                    notes: '', // Initialize notes field
                    createdAt: serverTimestamp()
                });

                document.getElementById('add-job-form').reset();
                messageEl.textContent = 'Job successfully added!';
                messageEl.classList.remove('text-red-500');
                messageEl.classList.add('text-green-600', 'bg-green-100', 'p-2', 'rounded-lg');
                setTimeout(() => messageEl.classList.add('hidden'), 3000);

            } catch (e) {
                console.error("Error adding document: ", e);
                messageEl.textContent = 'Error adding job: ' + e.message;
                messageEl.classList.add('text-red-500');
                messageEl.classList.remove('hidden');
            }
        }

        async function updateJobStatus(jobId, newStatus) {
            const jobsRef = getJobsCollectionRef();
            if (!jobsRef) return;

            try {
                const jobDocRef = doc(jobsRef, jobId);
                await updateDoc(jobDocRef, { status: newStatus });
            } catch (e) {
                console.error("Error updating status: ", e);
            }
        }

        async function updateJobNotes(jobId, notes) {
            const jobsRef = getJobsCollectionRef();
            if (!jobsRef) return;

            try {
                const jobDocRef = doc(jobsRef, jobId);
                await updateDoc(jobDocRef, { notes: notes });
                console.log(`Job ${jobId} notes updated.`);
            } catch (e) {
                console.error("Error updating notes: ", e);
            }
        }
        
        async function deleteJob(jobId) {
            const jobsRef = getJobsCollectionRef();
            if (!jobsRef) return;

            try {
                const jobDocRef = doc(jobsRef, jobId);
                await deleteDoc(jobDocRef);
            } catch (e) {
                console.error("Error deleting job:", e);
            }
        }

        // --- GEMINI API INTEGRATION ---

        /**
         * Generates a professional invoice summary from raw job notes using the Gemini API.
         * @param {string} jobNotes - The raw notes dictated or typed by the plumber.
         */
        async function generateInvoiceSummary(jobId, jobNotes) {
            showModal();
            const outputEl = document.getElementById('summary-output');
            const loadingEl = document.getElementById('summary-loading');
            const copyBtn = document.getElementById('copy-summary-btn');

            outputEl.innerHTML = '';
            loadingEl.classList.remove('hidden');
            copyBtn.classList.add('hidden');
            document.getElementById('copy-message').classList.add('hidden');

            if (!jobNotes || jobNotes.trim() === '') {
                loadingEl.classList.add('hidden');
                outputEl.innerHTML = '<p class="text-red-500">Error: Job notes are empty. Please add notes before generating a summary.</p>';
                return;
            }

            const systemPrompt = "You are a professional contractor's assistant. Your task is to transform raw job site notes into a concise, formal, customer-facing invoice summary. Organize the output into three sections using markdown bullet points for clarity: 'Work Performed', 'Materials Used (Inferred)', and 'Recommendations/Next Steps'. Do not include any introductory or concluding sentences. Only output the summary itself.";
            const userQuery = `Raw Job Notes: ${jobNotes}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const apiKey = ""; // Canvas provides the key
            const apiUrl = `${GEMINI_API_URL}${apiKey}`;

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                loadingEl.classList.add('hidden');
                
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (generatedText) {
                    // Convert markdown output (bullets and new lines) to HTML for display
                    outputEl.innerHTML = formatMarkdownToHtml(generatedText);
                    copyBtn.classList.remove('hidden');
                } else {
                    outputEl.innerHTML = '<p class="text-red-500">Could not generate summary. Please check notes for clarity and try again.</p>';
                }

            } catch (error) {
                console.error("Gemini API error:", error);
                loadingEl.classList.add('hidden');
                outputEl.innerHTML = `<p class="text-red-500">API Request Failed. Check console for details. (Error: ${error.message})</p>`;
            }
        }

        /**
         * Helper function to perform fetch with exponential backoff.
         */
        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                    if (response.status === 429 && i < retries - 1) { // Too many requests
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    throw new Error(`HTTP error! Status: ${response.status}`);
                } catch (error) {
                    if (i === retries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * Converts simple markdown list/paragraph structure to HTML for display.
         */
        function formatMarkdownToHtml(markdown) {
            // Replace * with list item bullet
            let html = markdown.replace(/^\* /gm, '<li>').replace(/\n/g, '<br>');
            
            // Add paragraphs for better spacing
            html = html.split('<br><br>').map(p => `<p class="mb-3">${p}</p>`).join('');

            // Simple handling for headers (if present) and bold
            html = html.replace(/^(#+)\s*(.*)$/gm, (match, hashes, content) => {
                const level = hashes.length > 3 ? 3 : hashes.length;
                return `<h${level} class="font-semibold mt-4 mb-2 text-gray-800 text-lg">${content}</h${level}>`;
            });
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Convert list item to unordered list block
            html = html.replace(/<li>(.*?)(<br>|$)/g, '<li>$1</li>');
            html = `<ul>${html}</ul>`;
            
            return html;
        }

        // --- MODAL UTILITIES ---

        function showModal() {
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('summary-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        window.closeModal = function() {
            document.getElementById('modal-backdrop').classList.add('hidden');
            document.getElementById('summary-modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        window.copySummary = function() {
            const summaryText = document.getElementById('summary-output').innerText;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = summaryText;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            
            try {
                // document.execCommand('copy') is the fallback for older browsers/environments
                const successful = document.execCommand('copy');
                const msg = document.getElementById('copy-message');
                if (successful) {
                    msg.textContent = 'Copied to clipboard!';
                    msg.classList.remove('hidden');
                } else {
                    msg.textContent = 'Copy failed. Please select and copy manually.';
                    msg.classList.remove('hidden');
                }
            } catch (err) {
                console.error('Copy failed:', err);
            }
            document.body.removeChild(tempTextArea);
        }

        // --- VOICE-TO-TEXT LOGIC (Unchanged from previous version) ---

        function setupVoiceRecognitionListeners() {
            if (!recognition) return;

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                
                if (currentRecordingJobId) {
                    const notesArea = document.getElementById(`notes-area-${currentRecordingJobId}`);
                    notesArea.value = notesArea.dataset.currentBase + finalTranscript + interimTranscript;
                }
            };

            recognition.onerror = (event) => {
                const statusEl = document.getElementById(`mic-status-${currentRecordingJobId}`);
                if (statusEl) {
                    statusEl.textContent = `Mic Error: ${event.error}. Click Save to keep partial notes.`;
                    statusEl.classList.remove('hidden');
                }
                stopVoiceInput();
            };

            recognition.onend = () => {
                const button = document.getElementById(`mic-btn-${currentRecordingJobId}`);
                if (button) {
                    button.classList.remove('is-recording');
                    button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7v0a7 7 0 01-7-7v0M12 18v3m4-18H8m8 0a4 4 0 01-4 4V3a4 4 0 014 4v0z" /></svg><span class="ml-1 hidden md:inline">Record Notes</span>';
                }
                currentRecordingJobId = null;
            };
        }

        function startVoiceInput(jobId) {
            if (!recognition) return;

            if (currentRecordingJobId) {
                stopVoiceInput();
            }

            const notesArea = document.getElementById(`notes-area-${jobId}`);
            const micButton = document.getElementById(`mic-btn-${jobId}`);
            const statusEl = document.getElementById(`mic-status-${jobId}`);

            notesArea.dataset.currentBase = notesArea.value;
            notesArea.value += ' ';
            
            currentRecordingJobId = jobId;
            recognition.start();

            micButton.classList.add('is-recording');
            micButton.innerHTML = '<div class="animate-pulse flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-100" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg><span class="ml-1 hidden md:inline">Stop & Save</span></div>';
            statusEl.textContent = 'Listening... Click the red button to stop.';
            statusEl.classList.remove('hidden', 'text-red-500');
            statusEl.classList.add('text-blue-500');
        }

        function stopVoiceInput() {
            if (recognition && currentRecordingJobId) {
                recognition.stop();
                const statusEl = document.getElementById(`mic-status-${currentRecordingJobId}`);
                if (statusEl) {
                    statusEl.textContent = 'Recording stopped. Click Save to finalize notes.';
                    statusEl.classList.remove('hidden', 'text-blue-500');
                    statusEl.classList.add('text-green-500');
                }
            }
        }


        // --- UI RENDERING & LISTENERS ---

        function renderJobs(jobs) {
            const container = document.getElementById('jobs-container');
            container.innerHTML = '';

            if (jobs.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-10 bg-white rounded-xl shadow-md border border-gray-200">
                        <p class="text-gray-500">No jobs currently scheduled. Add your first job above!</p>
                    </div>
                `;
                return;
            }

            jobs.forEach(job => {
                const statusClass = `status-${job.status.toLowerCase().replace(' ', '')}`;
                const scheduledDate = job.scheduledTime.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                const scheduledTime = job.scheduledTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

                const notesAreaId = `notes-area-${job.id}`;
                const micButtonId = `mic-btn-${job.id}`;

                const jobElement = document.createElement('div');
                jobElement.className = 'bg-white shadow-lg rounded-xl p-5 border-l-4 border-blue-500 flex flex-col justify-between items-start transition duration-150 hover:shadow-xl';
                jobElement.innerHTML = `
                    <div class="w-full flex justify-between items-start mb-4">
                        <!-- Job Details -->
                        <div class="flex-grow">
                            <p class="text-sm font-semibold text-gray-500">${scheduledDate} at ${scheduledTime}</p>
                            <h3 class="text-xl font-bold text-gray-900">${job.customerName}</h3>
                            <p class="text-sm text-gray-600">${job.address}</p>
                            <p class="text-md mt-1 font-medium text-blue-700">${job.description}</p>
                        </div>
                        
                        <!-- Status and Delete Button -->
                        <div class="flex flex-col space-y-2 items-end">
                            <span class="px-3 py-1 text-xs font-medium rounded-full uppercase ${statusClass}">
                                ${job.status}
                            </span>
                            <select data-job-id="${job.id}" class="status-selector bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 transition duration-150">
                                <option value="Scheduled" ${job.status === 'Scheduled' ? 'selected' : ''}>Scheduled</option>
                                <option value="On Site" ${job.status === 'On Site' ? 'selected' : ''}>On Site</option>
                                <option value="Completed" ${job.status === 'Completed' ? 'selected' : ''}>Completed</option>
                            </select>

                            <!-- Delete Button (GDPR Right to Erasure) -->
                            <button data-job-id="${job.id}" class="delete-job-button bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg text-sm shadow transition duration-150 flex items-center" title="Delete Job">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Voice-to-Text Notes Section -->
                    <div class="w-full mt-4 pt-4 border-t border-gray-200">
                        <h4 class="text-sm font-semibold text-gray-700 mb-2">Job Notes:</h4>
                        <textarea id="${notesAreaId}" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Type or dictate job notes..." data-current-base="">${job.notes || ''}</textarea>
                        
                        <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-2 mt-2">
                            <!-- Generate Summary Button -->
                            <button data-job-id="${job.id}" data-notes-id="${notesAreaId}" class="generate-summary-button bg-purple-500 hover:bg-purple-600 text-white p-2 rounded-lg text-sm shadow transition duration-150 flex items-center justify-center" title="Generate Invoice Summary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <span class="hidden md:inline">Invoice Summary</span>
                            </button>

                            <!-- Record Button -->
                            <button data-job-id="${job.id}" id="${micButtonId}" class="mic-toggle-button bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg text-sm shadow transition duration-150 flex items-center justify-center" title="Start Voice Input">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7v0a7 7 0 01-7-7v0M12 18v3m4-18H8m8 0a4 4 0 01-4 4V3a4 4 0 014 4v0z" />
                                </svg>
                                <span class="ml-1 hidden md:inline">Record Notes</span>
                            </button>

                            <!-- Save Button -->
                            <button data-job-id="${job.id}" class="save-notes-button bg-green-500 hover:bg-green-600 text-white p-2 rounded-lg text-sm shadow transition duration-150 flex items-center justify-center" title="Save Notes">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                <span class="ml-1 hidden md:inline">Save Notes</span>
                            </button>
                        </div>
                        <p id="mic-status-${job.id}" class="text-xs text-red-500 mt-1 hidden"></p>
                    </div>
                `;
                container.appendChild(jobElement);
            });

            // Attach event listeners to status, delete, mic, save, and summary buttons
            document.querySelectorAll('.status-selector').forEach(select => {
                select.addEventListener('change', (e) => updateJobStatus(e.target.dataset.jobId, e.target.value));
            });

            document.querySelectorAll('.delete-job-button').forEach(button => {
                button.addEventListener('click', (e) => deleteJob(e.currentTarget.dataset.jobId));
            });

            document.querySelectorAll('.mic-toggle-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const jobId = e.currentTarget.dataset.jobId;
                    if (currentRecordingJobId === jobId) {
                        stopVoiceInput();
                    } else {
                        startVoiceInput(jobId);
                    }
                });
            });

            document.querySelectorAll('.save-notes-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const jobId = e.currentTarget.dataset.jobId;
                    const notesArea = document.getElementById(`notes-area-${jobId}`);
                    
                    if (currentRecordingJobId === jobId) {
                        stopVoiceInput();
                    }
                    
                    updateJobNotes(jobId, notesArea.value);
                    
                    const statusEl = document.getElementById(`mic-status-${jobId}`);
                    statusEl.textContent = 'Notes saved successfully!';
                    statusEl.classList.remove('hidden', 'text-red-500', 'text-blue-500');
                    statusEl.classList.add('text-green-500');
                    setTimeout(() => statusEl.classList.add('hidden'), 3000);
                });
            });

            document.querySelectorAll('.generate-summary-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const notesArea = document.getElementById(e.currentTarget.dataset.notesId);
                    // Ensure the current notes are saved or update the Firestore copy locally before summarizing
                    // For simplicity, we use the value directly from the textarea
                    generateInvoiceSummary(e.currentTarget.dataset.jobId, notesArea.value);
                });
            });
        }


        /**
         * Sets up the event listener for the job submission form.
         */
        function setupFormListener() {
            const form = document.getElementById('add-job-form');
            form.addEventListener('submit', function(e) {
                e.preventDefault();

                const jobData = {
                    customerName: document.getElementById('customerName').value.trim(),
                    address: document.getElementById('address').value.trim(),
                    scheduledTime: document.getElementById('scheduledTime').value,
                    description: document.getElementById('description').value.trim(),
                };

                // Basic form validation
                if (!jobData.customerName || !jobData.address || !jobData.scheduledTime || !jobData.description) {
                    const messageEl = document.getElementById('form-message');
                    messageEl.textContent = 'Please fill in all fields.';
                    messageEl.classList.remove('hidden');
                    return;
                }

                addNewJob(jobData);
            });
        }
        
        // --- START APPLICATION ---
        window.onload = initializeFirebase;
    </script>
</body>
</html>
